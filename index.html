<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OPFS with JavaScript</title>
</head>

<body>
    <div id="container" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">Arrastra y suelta archivos aquí</div>
    <hr />
    <h2>Agregar archivo</h2>
    <input type="file" id="fileSelect" multiple />
    <button id="applyFunction">Aplicar función</button>
    <!-- Nuevo contenedor para arrastrar un archivo individualmente -->
    <div id="individualContainer" ondrop="dropIndividualHandler(event);" ondragover="dragOverIndividualHandler(event);">
        Arrastra un archivo aquí
    </div>

    <script>
        // Definir la variable $mainContainer como global
    const $mainContainer = document.querySelector('#container');
    const $individualContainer = document.querySelector('#individualContainer');

    // Definir la función dragOverHandler en el contexto global
    window.dragOverHandler = function (event) {
        event.preventDefault();
        $mainContainer.classList.add('dragover');
    }

    // Definir la función dragOverIndividualHandler en el contexto global
    window.dragOverIndividualHandler = function (event) {
        event.preventDefault();
        $individualContainer.classList.add('dragover');
    }

    document.addEventListener('DOMContentLoaded', async () => {
            const $fileSelect = document.querySelector('#fileSelect');
            const $applyFunctionButton = document.querySelector('#applyFunction');
            const directoryName = 'pictures';
            const opfsRoot = await navigator.storage.getDirectory();
            const picturesFolder = await opfsRoot.getDirectoryHandle(directoryName, {
                create: true,
            });

            const $mainContainer = document.querySelector('#container');
            const $individualContainer = document.querySelector('#individualContainer');

            $individualContainer.addEventListener('drop', async (event) => {
            event.preventDefault();
            $individualContainer.classList.remove('dragover');
            const files = event.dataTransfer.files;
            for (const file of files) {
                await processFile(file, picturesFolder);
            }
            // Renderiza los archivos después de procesar
            renderFiles(picturesFolder);
            });

            function dragOverHandler(event) {
                event.preventDefault();
                $mainContainer.classList.add('dragover');
            }

            function dragOverIndividualHandler(event) {
                event.preventDefault();
                $individualContainer.classList.add('dragover');
            }

            async function dropHandler(event) {
                event.preventDefault();
                $mainContainer.classList.remove('dragover');
                const files = event.dataTransfer.files;
                for (const file of files) {
                    await storeFile(file, picturesFolder);
                }
                renderFiles(picturesFolder);
            }

            async function processFile(file, folder) {
                // Lógica de procesamiento de archivos aquí
                const fileName = file.name;
                const fileHandle = await folder.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(await file.arrayBuffer());
                await writable.close();
                const fileBuffer = await file.arrayBuffer();  // Obtener el buffer del archivo
                await window.AlphaFoldXploR_read(fileBuffer);
            }
            window.AlphaFoldXploR_read = async (file) => {
                // Lógica necesaria para procesar el archivo aquí
                const fileName = file.name;
            
                if (fileName.endsWith(".json")) {
                    const content = await file.text();
                    // Procesa el contenido del archivo JSON según tus necesidades
                    console.log(`Contenido de ${fileName} (JSON): ${content}`);
                } else if (fileName.endsWith(".pdb")) {
                    const content = await file.text();
                    // Procesa el contenido del archivo PDB según tus necesidades
                    console.log(`Contenido de ${fileName} (PDB): ${content}`);
                } else {
                    console.log(`Tipo de archivo no compatible: ${fileName}`);
                }
            };

            const storeFile = async (file, folder) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async () => {
                        const fileName = file.name;
                        const fileHandle = await folder.getFileHandle(fileName, {
                            create: true,
                        });
                        const writable = await fileHandle.createWritable();
                        await writable.write(reader.result);
                        await writable.close();
                        resolve();
                    };
                    reader.onerror = (error) => {
                        reject(error);
                    };
                    reader.readAsArrayBuffer(file);
                });
            };

            const renderFiles = async (folder) => {
                while ($mainContainer.firstChild) {
                    $mainContainer.removeChild($mainContainer.firstChild);
                }

                for await (let [name, handle] of folder) {
                    const container = Object.assign(document.createElement('div'));
                    const anchorFileName = Object.assign(document.createElement('a'), {
                        textContent: name,
                        href: 'javascript:void(0)',
                        classList: ['file'],
                    });
                    const anchorRemove = Object.assign(document.createElement('a'), {
                        textContent: 'Eliminar',
                        href: 'javascript:void(0)',
                        classList: ['remove'],
                    });

                    anchorFileName.addEventListener('click', () => {
                        //await downloadFile(name, folder);
                        // La función downloadFile no está definida, así que la eliminamos
                        console.log('Descargar archivo', name);
                    });

                    anchorRemove.addEventListener('click', async () => {
                        await removeFile(name, folder);
                        await renderFiles(folder);
                    });

                    container.appendChild(anchorFileName);
                    container.appendChild(anchorRemove);
                    $mainContainer.append(container);
                }
            };

            $fileSelect.addEventListener('change', async () => {
                const files = $fileSelect.files;
                for (const file of files) {
                    await storeFile(file, picturesFolder);
                }
                $fileSelect.value = '';

                // Obtén la lista de archivos como un array antes de llamar a renderFiles
                const filesList = Array.from(await picturesFolder.keys());
                renderFiles(picturesFolder);
            });

            $applyFunctionButton.addEventListener('click', async () => {
                // Obtén la lista de archivos almacenados en la carpeta pictures
                const filesList = await picturesFolder.keys();

                // Llama a la función asincrónica processFiles para manejar la lógica de procesamiento
                await processFiles(filesList, picturesFolder);

                // Puedes agregar más lógica aquí después de procesar todos los archivos
                console.log('Aplicar función completada...');
            });

            async function processFile(file, folder) {
                const fileName = file.name;
                const fileHandle = await folder.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(await file.arrayBuffer());
                await writable.close();
            
                // Llama a AlphaFoldXploR_read para procesar el archivo
                await window.AlphaFoldXploR_read(fileHandle);
            }
            }
        });
           $mainContainer.addEventListener('dragleave', function () {
                $mainContainer.classList.remove('dragover');
            });
        
            $individualContainer.addEventListener('dragleave', function () {
                $individualContainer.classList.remove('dragover');
            });
       
    </script>
    <style>
        /* Estilo del contenedor principal */
        #container {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        #container.dragover {
            background-color: #f0f0f0;
        }

        /* Estilo del contenedor individual */
        #individualContainer {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        #individualContainer.dragover {
            background-color: #f0f0f0;
        }

        a {
            text-decoration: none;
        }

        a.file {
            color: #0ea5e9;
            font-size: 1.2rem;
        }

        a.remove {
            color: #dc2626;
            font-size: 0.8rem;
            margin-left: 0.4rem;
        }
    </style>
</body>

</html>
