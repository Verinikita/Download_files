<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OPFS with JavaScript</title>
  </head>

  <body>
    <div id="container" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);"></div>
    <hr />
    <h2>Agregar archivo</h2>
    <input type="file" id="fileSelect" multiple />
    <button id="applyFunction">Aplicar función</button>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const $mainContainer = document.querySelector('#container');
        const $fileSelect = document.querySelector('#fileSelect');
        const $applyFunctionButton = document.querySelector('#applyFunction');
        const directoryName = 'pictures';
        const outputDirectoryName1 = 'archivos_json';
        const outputDirectoryName2 = 'archivos_pdb';
        const opfsRoot = await navigator.storage.getDirectory();
        const picturesFolder = await opfsRoot.getDirectoryHandle(directoryName, {
          create: true,
        });
        const outputFolder1 = await opfsRoot.getDirectoryHandle(outputDirectoryName1, {
          create: true,
        });
        const outputFolder2 = await opfsRoot.getDirectoryHandle(outputDirectoryName2, {
          create: true,
        });

        const removeFile = async (fileName, folder) => {
          try {
            await folder.removeEntry(fileName);
          } catch (error) {
            console.error('Error al eliminar el archivo:', error);
          }
        };

        const storeFile = async (file, folder) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async () => {
              const fileName = file.name;
              const fileHandle = await folder.getFileHandle(fileName, {
                create: true,
              });
              const writable = await fileHandle.createWritable();
              await writable.write(reader.result);
              await writable.close();
              resolve();
            };
            reader.onerror = (error) => {
              reject(error);
            };
            reader.readAsArrayBuffer(file);
          });
        };

        const renderFiles = async (folder) => {
          while ($mainContainer.firstChild) {
            $mainContainer.removeChild($mainContainer.firstChild);
          }

          for await (let [name, handle] of folder) {
            const container = Object.assign(document.createElement('div'));
            const anchorFileName = Object.assign(document.createElement('a'), {
              textContent: name,
              href: 'javascript:void(0)',
              classList: ['file'],
            });
            const anchorRemove = Object.assign(document.createElement('a'), {
              textContent: 'Eliminar',
              href: 'javascript:void(0)',
              classList: ['remove'],
            });

            anchorFileName.addEventListener('click', () => {
              downloadFile(name, folder);
            });

            anchorRemove.addEventListener('click', async () => {
              await removeFile(name, folder);
              await renderFiles(folder);
            });

            container.appendChild(anchorFileName);
            container.appendChild(anchorRemove);
            $mainContainer.append(container);
          }
        };

        $fileSelect.addEventListener('change', async () => {
          const files = $fileSelect.files;
          for (const file of files) {
            await storeFile(file, picturesFolder);
          }
          $fileSelect.value = '';
          renderFiles(picturesFolder);
        });
        renderFiles(picturesFolder);

        // Función AlphaFoldXploR_read
        window.AlphaFoldXploR_read = async (folder) => {
          for await (let [name, handle] of folder) {
            if (name.endsWith('.json')) {
              const content = await readFileContents(handle);
              console.log(`Contenido de ${name}: ${content}`);

              // Almacena el archivo procesado en la carpeta de salida 1
              await storeProcessedFile(content, outputFolder1, name);
            }

            if (name.endsWith('.pdb')) {
              const content = await readFileContents(handle);
              console.log(`Contenido de ${name}: ${content}`);

              // Almacena el archivo procesado en la carpeta de salida 2
              await storeProcessedFile(content, outputFolder2, name);
            }
          }
        };

        const readFileContents = async (fileHandle) => {
          const file = await fileHandle.getFile();
          const content = await file.text();
          return content;
        };

        const storeProcessedFile = async (content, outputFolder, originalFileName) => {
          const processedFileName = `processed_${originalFileName}`;
          const fileHandle = await outputFolder.getFileHandle(processedFileName, {
            create: true,
          });
          const writable = await fileHandle.createWritable();
          await writable.write(content);
          await writable.close();
        };

        $applyFunctionButton.addEventListener('click', async () => {
          // Obtén la lista de archivos almacenados en la carpeta pictures
          const filesList = await picturesFolder.keys();

          // Llama a tu función AlphaFoldXploR_read para procesar cada archivo
          for (const fileNamePromise of filesList) {
            // Espera a que la Promise de fileName se resuelva y obtén el valor
            const fileName = await fileNamePromise;

            const fileHandle = await picturesFolder.getFileHandle(fileName);
            // Llama a tu función con el contenido del archivo
            await AlphaFoldXploR_read(fileHandle);
          }

          // Puedes agregar más lógica aquí después de procesar todos los archivos
          console.log('Aplicar función completada...');
        });
      });

      function dragOverHandler(event) {
        event.preventDefault();
        $mainContainer.classList.add('drag-over');
      }

      function dropHandler(event) {
        event.preventDefault();
        $mainContainer.classList.remove('drag-over');

        const files = event.dataTransfer.files;
        for (const file of files) {
          storeFile(file, picturesFolder);
        }
        renderFiles(picturesFolder);
      }
    </script>
    <style>
      a {
        text-decoration: none;
      }

      a.file {
        color: #0ea5e9;
        font-size: 1.2rem;
      }

      a.remove {
        color: #dc2626;
        font-size: 0.8rem;
        margin-left: 0.4rem;
      }

      #container {
        border: 2px dashed #aaa;
        padding: 20px;
        margin: 20px;
        cursor: pointer;
      }

      #container.drag-over {
        background-color: #eee;
      }
    </style>
  </body>
</html>

